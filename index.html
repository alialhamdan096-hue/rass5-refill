<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alrazi Refill Cash Patients System</title>
    <link rel="icon" href="logo.png" type="image/png">
    <style>
        :root {
            --primary: #561C2C;
            --primary-light: #7a2840;
            --accent: #8DC63F;
            --accent-dark: #6fa329;
            --text-dark: #333;
            --gray: #666;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(180deg, #f9f6f2 0%, #e8dccf 100%);
            color: var(--text-dark); 
            min-height: 100vh; 
            padding: 20px; 
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header-container { text-align: center; margin-bottom: 25px; }
        .logo-img { height: 90px; margin-bottom: 15px; filter: drop-shadow(0 2px 4px rgba(86, 28, 44, 0.2)); } 
        h1 { color: var(--primary); margin-bottom: 10px; font-weight: 700; }
        .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; }
        .tab { background: rgba(255, 255, 255, 0.7); border: none; padding: 12px 30px; border-radius: 30px; cursor: pointer; font-weight: bold; color: var(--gray); transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tab.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(86, 28, 44, 0.3); }
        .tab:hover:not(.active) { background: white; }
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .grid { display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
        @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
        .card { background: #fff; border-radius: 16px; padding: 25px; border: none; margin-bottom: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.07); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #555; font-size: 14px; font-weight: 600; }
        input, select { width: 100%; padding: 12px; background: #fafafa; border: 1px solid #ddd; border-radius: 8px; color: #333; font-size: 14px; transition: 0.3s; }
        input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(86, 28, 44, 0.1); background: white; }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        @media (max-width: 600px) {
            body { padding: 10px; }
            .header-container h1 { font-size: 20px; }
            .logo-img { height: 70px; }
            .tabs { gap: 5px; }
            .tab { padding: 10px 15px; font-size: 13px; }
            .card { padding: 15px; }
            .stats { grid-template-columns: 1fr 1fr; gap: 10px; }
            .stat { padding: 15px; }
            .stat-num { font-size: 24px; }
            .stat-label { font-size: 11px; }
            table { font-size: 13px; }
            th, td { padding: 10px 8px; }
            .actions { gap: 5px; }
            .actions button { width: 32px; height: 32px; font-size: 14px; }
            .badge { padding: 4px 8px; font-size: 10px; }
            .report-grid { grid-template-columns: 1fr; }
            .report-value { font-size: 36px; }
            .track-grid { grid-template-columns: 1fr; }
            .btn { padding: 10px 15px; }
            .header-row { flex-direction: column; align-items: flex-start; }
            input, select { padding: 10px; font-size: 16px; }
            .row { grid-template-columns: 1fr !important; }
            label { font-size: 13px; }
        }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; width: 100%; margin-top: 10px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-light); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-sm { padding: 8px 16px; width: auto; margin: 0; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 15px; }
        th { text-align: left; padding: 15px; background: #f9f9f9; color: var(--gray); font-size: 12px; text-transform: uppercase; border-bottom: 2px solid #eee; }
        td { padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
        tr:hover { background: #fcfcfc; }
        .name { font-weight: bold; color: var(--primary); }
        .phone { color: #888; font-size: 13px; margin-top: 2px; }
        .med { color: var(--primary); font-weight: 500; }
        .badge { padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: bold; letter-spacing: 0.5px; }
        .badge-ok { background: rgba(141, 198, 63, 0.15); color: var(--accent-dark); }
        .badge-warn { background: rgba(245,158,11,0.15); color: #d97706; }
        .badge-danger { background: rgba(239,68,68,0.15); color: #dc2626; }
        .actions { display: flex; gap: 8px; }
        .actions button { width: 36px; height: 36px; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .wa { background: #25D366; color: white; }
        .edit { background: rgba(86, 28, 44, 0.1); color: var(--primary); }
        .del { background: rgba(239,68,68,0.1); color: #ef4444; }
        .actions button:hover { transform: translateY(-2px); }
        .empty { text-align: center; padding: 50px; color: #aaa; font-style: italic; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat { background: white; padding: 20px; border-radius: 12px; border: none; box-shadow: 0 5px 15px rgba(0,0,0,0.05); position: relative; overflow: hidden; }
        .stat::after { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--gray); }
        .stat-num { font-size: 32px; font-weight: 800; color: var(--text-dark); }
        .stat-label { color: #888; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 5px; }
        .stat.total::after { background: var(--primary); }
        .stat.w::after { background: #f59e0b; }
        .stat.d::after { background: #ef4444; }
        .stat.s::after { background: var(--accent); }
        .sync { text-align: center; padding: 8px; font-size: 13px; margin-bottom: 15px; border-radius: 8px; background: rgba(255,255,255,0.8); }
        .sync-ok { color: var(--accent-dark); border: 1px solid rgba(141, 198, 63, 0.3); }
        .sync-err { color: #ef4444; border: 1px solid rgba(239,68,68,0.3); }
        .track-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .track-card { background: white; border: 1px solid #eee; border-radius: 12px; padding: 20px; transition: 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .track-card:hover { border-color: var(--primary); transform: translateY(-2px); }
        .track-card.converted { border-color: var(--accent); background: rgba(141, 198, 63, 0.05); }
        .track-card .name { font-size: 16px; margin-bottom: 5px; color: #333; }
        .track-card .med { margin: 10px 0; color: var(--primary); font-size: 14px; }
        .track-card .info { font-size: 12px; color: #888; margin-bottom: 15px; line-height: 1.5; }
        .track-card .history-badge { font-size: 11px; color: var(--accent-dark); background: rgba(141,198,63,0.1); padding: 4px 8px; border-radius: 10px; margin-bottom: 10px; display: inline-block; }
        .track-btn { width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; background: rgba(141, 198, 63, 0.15); color: var(--accent-dark); transition: 0.2s; margin-bottom: 8px; }
        .track-btn:hover { background: var(--accent); color: white; }
        .track-btn.done { background: var(--accent); color: white; }
        .track-btn.renew { background: rgba(86, 28, 44, 0.1); color: var(--primary); }
        .track-btn.renew:hover { background: var(--primary); color: white; }
        .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .report-card { background: #fff; border-radius: 12px; padding: 25px; border: none; text-align: center; box-shadow: 0 8px 25px rgba(0,0,0,0.07); }
        .report-value { font-size: 48px; font-weight: bold; color: var(--primary); }
        .report-label { font-size: 14px; color: #888; margin-top: 5px; }
        .progress { height: 10px; background: #eee; border-radius: 6px; margin-top: 15px; overflow: hidden; }
        .progress-bar { height: 100%; border-radius: 6px; }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
            <img src="logo.png" alt="Alrazi Pharmacy" class="logo-img" onerror="this.style.display='none'"> 
            <h1>Alrazi Refill Cash Patients System</h1>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showPage('patients')">üìã Patients</button>
            <button class="tab" onclick="showPage('tracking')">üìä Tracking</button>
            <button class="tab" onclick="showPage('reports')">üìà Reports</button>
        </div>
        
        <div id="sync" class="sync sync-ok">‚úì Connected to Google Sheets</div>

        <div id="patientsPage" class="page active">
            <div class="stats">
                <div class="stat total"><div class="stat-num" id="total">0</div><div class="stat-label">Total Patients</div></div>
                <div class="stat w"><div class="stat-num" id="warn">0</div><div class="stat-label">Need Reminder</div></div>
                <div class="stat d"><div class="stat-num" id="over">0</div><div class="stat-label">Overdue</div></div>
            </div>

            <div class="grid">
                <div class="card">
                    <h3 style="margin-bottom:20px; color:var(--primary);" id="formTitle">Add Patient</h3>
                    <form id="form">
                        <div class="form-group"><label>Patient Name (Optional)</label><input type="text" id="name"></div>
                        <div class="form-group"><label>Phone (e.g. 966512345678)</label><input type="tel" id="phone" required></div>
                        <div class="form-group"><label>Medication</label><input type="text" id="med" required></div>
                        <div class="row">
                            <div class="form-group"><label>Dispense Date</label><input type="date" id="date" required></div>
                            <div class="form-group"><label>Duration (days)</label><input type="number" id="days" value="30" required></div>
                        </div>
                        <div class="form-group"><label>Notes</label><input type="text" id="notes"></div>
                        <button type="submit" class="btn btn-primary" id="submitBtn">Add Patient</button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">Cancel</button>
                    </form>
                </div>

                <div class="card">
                    <h3 style="color:var(--primary); margin-bottom:15px;">Patient Records</h3>
                    <input type="text" id="search" placeholder="üîç Search patient, med or phone..." oninput="renderPatients()" style="margin-bottom: 15px;">
                    <div style="overflow-x: auto;">
                        <table>
                            <thead><tr><th>Patient</th><th>Medication</th><th>Refill Date</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="patientsTbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="trackingPage" class="page">
            <div class="stats">
                <div class="stat total"><div class="stat-num" id="tSent">0</div><div class="stat-label">Reminders Sent</div></div>
                <div class="stat s"><div class="stat-num" id="tConverted">0</div><div class="stat-label">Converted</div></div>
                <div class="stat" style="border-left: 4px solid var(--primary);"><div class="stat-num" id="tRate">0%</div><div class="stat-label">Conversion Rate</div></div>
            </div>

            <div class="card">
                <div class="header-row">
                    <h3 style="color:var(--primary);">üìä Track Conversions</h3>
                    <select id="trackFilter" onchange="renderTracking()" style="width: auto; min-width: 150px;">
                        <option value="all">All Sent</option>
                        <option value="waiting">‚è≥ Waiting</option>
                        <option value="converted">‚úÖ Converted</option>
                    </select>
                </div>
                <div class="track-grid" id="trackGrid"></div>
            </div>
        </div>

        <div id="reportsPage" class="page">
            <div class="card">
                <div class="header-row">
                    <h3 style="color:var(--primary);">üìà Monthly Report</h3>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <select id="reportMonth" onchange="genReport()" style="width: auto;">
                            <option value="0">January</option><option value="1">February</option><option value="2">March</option>
                            <option value="3">April</option><option value="4">May</option><option value="5">June</option>
                            <option value="6">July</option><option value="7">August</option><option value="8">September</option>
                            <option value="9">October</option><option value="10">November</option><option value="11">December</option>
                        </select>
                        <select id="reportYear" onchange="genReport()" style="width: auto;">
                            <option value="2026">2026</option><option value="2027">2027</option><option value="2028">2028</option><option value="2029">2029</option>
                        </select>
                        <button class="btn btn-secondary btn-sm" onclick="window.print()">üñ®Ô∏è Print</button>
                    </div>
                </div>
            </div>
            
            <div class="report-grid">
                <div class="report-card">
                    <div class="report-value" id="rSent">0</div>
                    <div class="report-label">üì§ Reminders Sent</div>
                </div>
                <div class="report-card">
                    <div class="report-value" style="color: var(--accent);" id="rConverted">0</div>
                    <div class="report-label">‚úÖ Converted</div>
                </div>
                <div class="report-card">
                    <div class="report-value" style="color: var(--primary);" id="rRate">0%</div>
                    <div class="report-label">üìä Conversion Rate</div>
                    <div class="progress"><div class="progress-bar" id="rBar" style="width:0%; background:var(--accent);"></div></div>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 20px; color:var(--primary);">üìã Summary</h3>
                <table>
                    <thead><tr><th>Metric</th><th>Count</th><th>Percentage</th></tr></thead>
                    <tbody id="summaryTb"></tbody>
                </table>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 20px; color:var(--primary);">‚úÖ Converted Patients</h3>
                <table>
                    <thead><tr><th>Patient</th><th>Phone</th><th>Medication</th><th>Reminder Date</th><th>Converted Date</th></tr></thead>
                    <tbody id="convList"></tbody>
                </table>
            </div>
        </div>
    </div>

<script>
const API = 'https://script.google.com/macros/s/AKfycbxttAQK6oEqdmqekXHto2_tBIkTVAmcwNA8rrHQkEcabwVayNwPSIc19zp68D9UG22POw/exec';
let patients = [];
let editId = null;

document.getElementById('reportMonth').value = new Date().getMonth();
document.getElementById('reportYear').value = new Date().getFullYear();
document.getElementById('date').valueAsDate = new Date();

loadData();

function showPage(p) {
    document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    document.getElementById(p + 'Page').classList.add('active');
    event.target.classList.add('active');
    if (p === 'tracking') renderTracking();
    if (p === 'reports') genReport();
}

async function loadData() {
    document.getElementById('patientsTbody').innerHTML = '<tr><td colspan="5"><div class="empty">Loading...</div></td></tr>';
    try {
        const res = await fetch(API + '?action=get');
        const data = await res.json();
        patients = data.map(p => ({
            id: String(p.id || ''),
            name: p.name || '',
            phone: String(p.phone || ''),
            med: p.med || '',
            date: fmtDate(p.date),
            days: String(p.days || '30'),
            notes: p.notes || '',
            reminderSent: p.reminderSent || 'no',
            reminderDate: fmtDate(p.reminderDate),
            converted: p.converted || 'no',
            convertedDate: fmtDate(p.convertedDate),
            history: parseHistory(p.history)
        }));
        syncStatus(true);
        renderPatients();
    } catch (e) {
        syncStatus(false);
        patients = JSON.parse(localStorage.getItem('patients')) || [];
        renderPatients();
    }
}

function parseHistory(h) {
    if (!h) return [];
    if (Array.isArray(h)) return h;
    try { return JSON.parse(h); } catch(e) { return []; }
}

function fmtDate(v) {
    if (!v) return '';
    if (typeof v === 'string' && v.match(/^\d{4}-\d{2}-\d{2}$/)) return v;
    const d = new Date(v);
    if (isNaN(d)) return v;
    return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}

function getToday() {
    const t = new Date();
    return t.getFullYear() + '-' + String(t.getMonth()+1).padStart(2,'0') + '-' + String(t.getDate()).padStart(2,'0');
}

function syncStatus(ok) {
    const el = document.getElementById('sync');
    el.className = ok ? 'sync sync-ok' : 'sync sync-err';
    el.textContent = ok ? '‚úì Connected to Google Sheets' : '‚ö† Offline Mode';
}

document.getElementById('form').onsubmit = async function(e) {
    e.preventDefault();
    const btn = document.getElementById('submitBtn');
    btn.disabled = true; btn.textContent = 'Saving...';
    
    const p = {
        id: editId || Date.now().toString(),
        name: document.getElementById('name').value,
        phone: document.getElementById('phone').value.replace(/\D/g, ''),
        med: document.getElementById('med').value,
        date: document.getElementById('date').value,
        days: document.getElementById('days').value,
        notes: document.getElementById('notes').value,
        reminderSent: 'no', reminderDate: '', converted: 'no', convertedDate: '',
        history: []
    };
    
    if (editId) {
        const old = patients.find(x => x.id === editId);
        p.reminderSent = old.reminderSent; p.reminderDate = old.reminderDate;
        p.converted = old.converted; p.convertedDate = old.convertedDate;
        p.history = old.history || [];
    }
    
    await saveToServer(p, editId ? 'update' : 'add');
    if (editId) patients[patients.findIndex(x => x.id === editId)] = p;
    else patients.push(p);
    localStorage.setItem('patients', JSON.stringify(patients));
    
    renderPatients(); resetForm();
    btn.disabled = false; btn.textContent = 'Add Patient';
};

async function saveToServer(p, action) {
    const d = {...p, history: JSON.stringify(p.history || [])};
    try {
        await fetch(API + '?action=' + action + '&data=' + encodeURIComponent(JSON.stringify(d)));
        syncStatus(true);
    } catch (e) { syncStatus(false); }
}

function resetForm() {
    editId = null;
    document.getElementById('form').reset();
    document.getElementById('days').value = '30';
    document.getElementById('date').valueAsDate = new Date();
    document.getElementById('formTitle').textContent = 'Add Patient';
    document.getElementById('submitBtn').textContent = 'Add Patient';
}

function editP(id) {
    const p = patients.find(x => x.id === id);
    editId = id;
    document.getElementById('name').value = p.name;
    document.getElementById('phone').value = p.phone;
    document.getElementById('med').value = p.med;
    document.getElementById('date').value = p.date;
    document.getElementById('days').value = p.days;
    document.getElementById('notes').value = p.notes || '';
    document.getElementById('formTitle').textContent = 'Edit Patient';
    document.getElementById('submitBtn').textContent = 'Update';
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

async function delP(id) {
    if (confirm('Delete this patient?')) {
        try { await fetch(API + '?action=delete&id=' + id); } catch (e) {}
        patients = patients.filter(x => x.id !== id);
        localStorage.setItem('patients', JSON.stringify(patients));
        renderPatients();
    }
}

function sendWA(id) {
    const p = patients.find(x => x.id === id);
    const msg = `ÿßŸÑÿ≥ŸÑÿßŸÖ ÿπŸÑŸäŸÉŸÖ Ÿàÿ±ÿ≠ŸÖÿ© ÿßŸÑŸÑŸá Ÿàÿ®ÿ±ŸÉÿßÿ™Ÿá
ÿµŸäÿØŸÑŸäÿ© ÿßŸÑÿ±ÿßÿ≤Ÿä ÿßŸÑÿ±ÿ≥ 1 ÿ™ÿ±ÿ≠ÿ® ÿ®ŸÉŸÖ

Ÿáÿ∞ÿß ÿ™ÿ∞ŸÉŸäÿ± ÿ®ŸÖŸàÿπÿØ ÿµÿ±ŸÅ ÿßŸÑÿØŸàÿßÿ° ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ:

ÿßŸÑÿØŸàÿßÿ°: ${p.med}

ŸÜÿ≥ÿπÿØ ÿ®ÿ™ÿ¨ŸáŸäÿ≤Ÿá ŸÑŸÉŸÖ ÿπÿ®ÿ±:

- ÿßŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ ŸÖŸÜ ÿßŸÑÿµŸäÿØŸÑŸäÿ©

- ÿßŸÑÿ™ŸàÿµŸäŸÑ ŸÑŸÖŸàŸÇÿπŸÉŸÖ

ŸÖŸàŸÇÿπ ÿßŸÑÿµŸäÿØŸÑŸäÿ©:
https://shorturl.at/M2Cq3

ŸÜÿ™ŸÖŸÜŸâ ŸÑŸÉŸÖ ÿØŸàÿßŸÖ ÿßŸÑÿµÿ≠ÿ© ŸàÿßŸÑÿπÿßŸÅŸäÿ©`;
    window.open('https://wa.me/' + p.phone + '?text=' + encodeURIComponent(msg), '_blank');
    p.reminderSent = 'yes';
    p.reminderDate = getToday();
    saveP(p);
}

async function saveP(p) {
    await saveToServer(p, 'update');
    localStorage.setItem('patients', JSON.stringify(patients));
    renderPatients(); renderTracking();
}

async function markConverted(id) {
    const p = patients.find(x => x.id === id);
    p.converted = 'yes';
    p.convertedDate = getToday();
    await saveP(p);
}

async function undoConverted(id) {
    const p = patients.find(x => x.id === id);
    p.converted = 'no';
    p.convertedDate = '';
    await saveP(p);
}

async function renewPatient(id) {
    const p = patients.find(x => x.id === id);
    if (!p.history) p.history = [];
    p.history.push({
        date: p.date,
        reminderDate: p.reminderDate,
        convertedDate: p.convertedDate
    });
    p.date = getToday();
    p.reminderSent = 'no';
    p.reminderDate = '';
    p.converted = 'no';
    p.convertedDate = '';
    await saveP(p);
}

function getRefill(p) {
    const d = new Date(p.date);
    d.setDate(d.getDate() + parseInt(p.days));
    return d;
}

function getDays(p) {
    const today = new Date(); today.setHours(0,0,0,0);
    const refill = getRefill(p); refill.setHours(0,0,0,0);
    return Math.ceil((refill - today) / (1000*60*60*24));
}

function renderPatients() {
    const search = document.getElementById('search').value.toLowerCase();
    let list = patients.filter(p => p.name.toLowerCase().includes(search) || p.med.toLowerCase().includes(search) || p.phone.includes(search));
    list.sort((a,b) => getRefill(a) - getRefill(b));
    
    let w=0, o=0;
    patients.forEach(p => { const d = getDays(p); if (d < 0) o++; else if (d <= 2) w++; });
    document.getElementById('total').textContent = patients.length;
    document.getElementById('warn').textContent = w;
    document.getElementById('over').textContent = o;

    const tbody = document.getElementById('patientsTbody');
    if (list.length === 0) { tbody.innerHTML = '<tr><td colspan="5"><div class="empty">No patients found</div></td></tr>'; return; }
    
    tbody.innerHTML = list.map(p => {
        const d = getDays(p);
        const refill = getRefill(p).toLocaleDateString('en-US', {year:'numeric', month:'short', day:'numeric'});
        let st, sc;
        if (d < 0) { st = 'Overdue ' + Math.abs(d) + 'd'; sc = 'danger'; }
        else if (d <= 2) { st = d + 'd left'; sc = 'warn'; }
        else { st = d + 'd left'; sc = 'ok'; }
        const hc = (p.history || []).length;
        const hb = hc > 0 ? ' <span class="badge badge-ok">'+hc+' renewals</span>' : '';
        return '<tr><td><div class="name">'+p.name+hb+'</div><div class="phone">'+p.phone+'</div></td><td><div class="med">'+p.med+'</div>'+(p.notes?'<div class="phone">'+p.notes+'</div>':'')+'</td><td>'+refill+'</td><td><span class="badge badge-'+sc+'">'+st+'</span></td><td><div class="actions"><button class="wa" onclick="sendWA(\''+p.id+'\')" title="WhatsApp"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/></svg></button><button class="edit" onclick="editP(\''+p.id+'\')" title="Edit">‚úèÔ∏è</button><button class="del" onclick="delP(\''+p.id+'\')" title="Delete">üóëÔ∏è</button></div></td></tr>';
    }).join('');
}

function renderTracking() {
    const filter = document.getElementById('trackFilter').value;
    let list = patients.filter(p => p.reminderSent === 'yes');
    if (filter === 'waiting') list = list.filter(p => p.converted !== 'yes');
    else if (filter === 'converted') list = list.filter(p => p.converted === 'yes');
    list.sort((a,b) => new Date(b.reminderDate) - new Date(a.reminderDate));
    
    let totalSent = 0, totalConv = 0;
    patients.forEach(p => {
        if (p.reminderSent === 'yes') totalSent++;
        if (p.converted === 'yes') totalConv++;
        (p.history || []).forEach(h => {
            if (h.reminderDate) totalSent++;
            if (h.convertedDate) totalConv++;
        });
    });
    
    document.getElementById('tSent').textContent = totalSent;
    document.getElementById('tConverted').textContent = totalConv;
    document.getElementById('tRate').textContent = totalSent > 0 ? Math.round(totalConv/totalSent*100) + '%' : '0%';
    
    const grid = document.getElementById('trackGrid');
    if (list.length === 0) { grid.innerHTML = '<div class="empty" style="grid-column:1/-1;">No records found</div>'; return; }
    
    grid.innerHTML = list.map(p => {
        const hc = (p.history || []).length;
        const hb = hc > 0 ? '<div class="history-badge">üîÑ '+hc+' previous cycles</div>' : '';
        if (p.converted === 'yes') {
            return '<div class="track-card converted">'+hb+'<div class="name">'+p.name+'</div><div class="phone">'+p.phone+'</div><div class="med">'+p.med+'</div><div class="info">üì§ Sent: '+p.reminderDate+'<br>‚úÖ Converted: '+p.convertedDate+'</div><button class="track-btn done" onclick="undoConverted(\''+p.id+'\')">‚úÖ Converted (Click to Undo)</button><button class="track-btn renew" onclick="renewPatient(\''+p.id+'\')">üîÑ Renew for Next Month</button></div>';
        } else {
            return '<div class="track-card">'+hb+'<div class="name">'+p.name+'</div><div class="phone">'+p.phone+'</div><div class="med">'+p.med+'</div><div class="info">üì§ Sent: '+p.reminderDate+'</div><button class="track-btn" onclick="markConverted(\''+p.id+'\')">‚úÖ Mark as Converted</button></div>';
        }
    }).join('');
}

function genReport() {
    const m = parseInt(document.getElementById('reportMonth').value);
    const y = parseInt(document.getElementById('reportYear').value);
    
    let sent = 0, conv = 0, convPatients = [];
    
    patients.forEach(p => {
        if (p.reminderSent === 'yes' && p.reminderDate) {
            const rd = new Date(p.reminderDate);
            if (rd.getMonth() === m && rd.getFullYear() === y) {
                sent++;
                if (p.converted === 'yes') {
                    conv++;
                    convPatients.push({name: p.name, phone: p.phone, med: p.med, reminderDate: p.reminderDate, convertedDate: p.convertedDate});
                }
            }
        }
        (p.history || []).forEach(h => {
            if (h.reminderDate) {
                const rd = new Date(h.reminderDate);
                if (rd.getMonth() === m && rd.getFullYear() === y) {
                    sent++;
                    if (h.convertedDate) {
                        conv++;
                        convPatients.push({name: p.name, phone: p.phone, med: p.med, reminderDate: h.reminderDate, convertedDate: h.convertedDate});
                    }
                }
            }
        });
    });
    
    const rate = sent > 0 ? Math.round(conv/sent*100) : 0;
    
    document.getElementById('rSent').textContent = sent;
    document.getElementById('rConverted').textContent = conv;
    document.getElementById('rRate').textContent = rate + '%';
    document.getElementById('rBar').style.width = rate + '%';
    
    document.getElementById('summaryTb').innerHTML = '<tr><td>üì§ Reminders Sent</td><td>'+sent+'</td><td>100%</td></tr><tr><td>‚úÖ Converted</td><td>'+conv+'</td><td>'+rate+'%</td></tr><tr><td>‚è≥ Waiting</td><td>'+(sent-conv)+'</td><td>'+(sent > 0 ? Math.round((sent-conv)/sent*100) : 0)+'%</td></tr>';
    
    document.getElementById('convList').innerHTML = convPatients.length > 0 
        ? convPatients.map(p => '<tr><td class="name">'+p.name+'</td><td class="phone">'+p.phone+'</td><td class="med">'+p.med+'</td><td>'+p.reminderDate+'</td><td>'+p.convertedDate+'</td></tr>').join('')
        : '<tr><td colspan="5"><div class="empty">No conversions this month</div></td></tr>';
}
</script>
</body>
</html>
