<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rass 5 Refill Cash Patients System</title>
    <link rel="icon" href="logo.png" type="image/png">
    <style>
        :root {
            --primary: #561C2C;
            --primary-light: #7a2840;
            --primary-dark: #3d1420;
            --accent: #8DC63F;
            --accent-dark: #6fa329;
            --text-dark: #333;
            --text-light: #666;
            --gray: #666;
            --gray-light: #f5f5f5;
            --white: #fff;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 25px rgba(0,0,0,0.1);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-full: 9999px;
            --transition: 0.3s ease;
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(180deg, #f9f6f2 0%, #e8dccf 100%);
            color: var(--text-dark); 
            min-height: 100vh; 
            padding: 20px;
            line-height: 1.6;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 16px 24px;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 500;
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 280px;
        }

        .toast-success { background: var(--success); }
        .toast-error { background: var(--danger); }
        .toast-warning { background: var(--warning); }
        .toast-info { background: var(--info); }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--gray-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
        }

        /* Header */
        .header-container { 
            text-align: center; 
            margin-bottom: 25px; 
        }

        .logo-img { 
            height: 90px; 
            margin-bottom: 15px; 
            filter: drop-shadow(0 2px 4px rgba(86, 28, 44, 0.2)); 
        }

        h1 { 
            color: var(--primary); 
            margin-bottom: 10px; 
            font-weight: 700; 
        }

        /* Tabs */
        .tabs { 
            display: flex; 
            justify-content: center; 
            gap: 10px; 
            margin-bottom: 25px; 
            flex-wrap: wrap; 
        }

        .tab { 
            background: rgba(255, 255, 255, 0.7); 
            border: none; 
            padding: 12px 30px; 
            border-radius: var(--radius-full); 
            cursor: pointer; 
            font-weight: bold; 
            color: var(--gray); 
            transition: var(--transition); 
            box-shadow: var(--shadow-sm);
        }

        .tab.active { 
            background: var(--primary); 
            color: white; 
            box-shadow: 0 4px 10px rgba(86, 28, 44, 0.3); 
        }

        .tab:hover:not(.active) { 
            background: white; 
            transform: translateY(-2px);
        }

        /* Pages */
        .page { 
            display: none; 
            animation: fadeIn 0.3s ease; 
        }

        .page.active { 
            display: block; 
        }

        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(5px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* Grid Layout */
        .grid { 
            display: grid; 
            grid-template-columns: 350px 1fr; 
            gap: 20px; 
        }

        @media (max-width: 900px) { 
            .grid { grid-template-columns: 1fr; } 
        }

        /* Cards */
        .card { 
            background: var(--white); 
            border-radius: var(--radius-lg); 
            padding: 25px; 
            margin-bottom: 20px; 
            box-shadow: var(--shadow-lg); 
        }

        .card-title {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Form Elements */
        .form-group { 
            margin-bottom: 15px; 
        }

        label { 
            display: block; 
            margin-bottom: 6px; 
            color: #555; 
            font-size: 14px; 
            font-weight: 600; 
        }

        input, select { 
            width: 100%; 
            padding: 12px 14px; 
            background: #fafafa; 
            border: 2px solid #e5e5e5; 
            border-radius: var(--radius-sm); 
            color: #333; 
            font-size: 14px; 
            transition: var(--transition); 
        }

        input:focus, select:focus { 
            outline: none; 
            border-color: var(--primary); 
            box-shadow: 0 0 0 3px rgba(86, 28, 44, 0.1); 
            background: white; 
        }

        input.error {
            border-color: var(--danger);
            background: #fef2f2;
        }

        .error-message {
            color: var(--danger);
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .row { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
        }

        /* Buttons */
        .btn { 
            padding: 12px 20px; 
            border: none; 
            border-radius: var(--radius-sm); 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: bold; 
            width: 100%; 
            margin-top: 10px; 
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary { 
            background: var(--primary); 
            color: white; 
        }

        .btn-primary:hover:not(:disabled) { 
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary { 
            background: #6c757d; 
            color: white; 
        }

        .btn-secondary:hover:not(:disabled) { 
            background: #5a6268; 
        }

        .btn:disabled { 
            opacity: 0.6; 
            cursor: not-allowed; 
            transform: none !important;
        }

        .btn-sm { 
            padding: 8px 16px; 
            width: auto; 
            margin: 0; 
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            margin-top: 15px;
        }

        table { 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0; 
        }

        th { 
            text-align: left; 
            padding: 15px; 
            background: #f9f9f9; 
            color: var(--gray); 
            font-size: 12px; 
            text-transform: uppercase; 
            border-bottom: 2px solid #eee;
            white-space: nowrap;
        }

        td { 
            padding: 15px; 
            border-bottom: 1px solid #eee; 
            vertical-align: middle; 
        }

        tr:hover { 
            background: #fcfcfc; 
        }

        .name { 
            font-weight: bold; 
            color: var(--primary); 
        }

        .phone { 
            color: #888; 
            font-size: 13px; 
            margin-top: 2px;
        }

        .med { 
            color: var(--primary); 
            font-weight: 500; 
        }

        /* Badges */
        .badge { 
            padding: 6px 14px; 
            border-radius: var(--radius-full); 
            font-size: 11px; 
            font-weight: bold; 
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .badge-ok { 
            background: rgba(141, 198, 63, 0.15); 
            color: var(--accent-dark); 
        }

        .badge-warn { 
            background: rgba(245,158,11,0.15); 
            color: #d97706; 
        }

        .badge-danger { 
            background: rgba(239,68,68,0.15); 
            color: #dc2626; 
        }

        /* Actions */
        .actions { 
            display: flex; 
            gap: 8px; 
        }

        .actions button { 
            width: 36px; 
            height: 36px; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            font-size: 16px; 
            transition: var(--transition); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }

        .wa { background: #25D366; color: white; }
        .edit { background: rgba(86, 28, 44, 0.1); color: var(--primary); }
        .del { background: rgba(239,68,68,0.1); color: #ef4444; }

        .actions button:hover { 
            transform: translateY(-2px); 
            box-shadow: var(--shadow-sm);
        }

        .empty { 
            text-align: center; 
            padding: 50px; 
            color: #aaa; 
            font-style: italic; 
        }

        /* Stats */
        .stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 15px; 
            margin-bottom: 25px; 
        }

        .stat { 
            background: white; 
            padding: 20px; 
            border-radius: var(--radius-md); 
            box-shadow: var(--shadow-md); 
            position: relative; 
            overflow: hidden; 
        }

        .stat::after { 
            content: ''; 
            position: absolute; 
            left: 0; 
            top: 0; 
            bottom: 0; 
            width: 4px; 
            background: var(--gray); 
        }

        .stat-num { 
            font-size: 32px; 
            font-weight: 800; 
            color: var(--text-dark); 
        }

        .stat-label { 
            color: #888; 
            font-size: 13px; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            margin-top: 5px; 
        }

        .stat.total::after { background: var(--primary); }
        .stat.w::after { background: #f59e0b; }
        .stat.d::after { background: #ef4444; }
        .stat.s::after { background: var(--accent); }

        /* Sync Status */
        .sync { 
            text-align: center; 
            padding: 10px 16px; 
            font-size: 13px; 
            margin-bottom: 15px; 
            border-radius: var(--radius-sm); 
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .sync-ok { 
            color: var(--accent-dark); 
            border: 1px solid rgba(141, 198, 63, 0.3); 
        }

        .sync-err { 
            color: #ef4444; 
            border: 1px solid rgba(239,68,68,0.3); 
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 8px 14px;
            border: 1px solid #ddd;
            background: white;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
        }

        .pagination button:hover:not(:disabled) {
            border-color: var(--primary);
            color: var(--primary);
        }

        .pagination button.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            color: var(--gray);
            font-size: 13px;
        }

        /* Tracking Cards */
        .track-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 15px; 
        }

        .track-card { 
            background: white; 
            border: 2px solid #eee; 
            border-radius: var(--radius-md); 
            padding: 20px; 
            transition: var(--transition); 
            box-shadow: var(--shadow-sm); 
        }

        .track-card:hover { 
            border-color: var(--primary); 
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .track-card.converted { 
            border-color: var(--accent); 
            background: rgba(141, 198, 63, 0.05); 
        }

        .track-card .name { 
            font-size: 16px; 
            margin-bottom: 5px; 
            color: #333; 
        }

        .track-card .med { 
            margin: 10px 0; 
            color: var(--primary); 
            font-size: 14px; 
        }

        .track-card .info { 
            font-size: 12px; 
            color: #888; 
            margin-bottom: 15px; 
            line-height: 1.6; 
        }

        .track-card .history-badge { 
            font-size: 11px; 
            color: var(--accent-dark); 
            background: rgba(141,198,63,0.1); 
            padding: 4px 10px; 
            border-radius: var(--radius-full); 
            margin-bottom: 10px; 
            display: inline-block; 
        }

        .track-btn { 
            width: 100%; 
            padding: 12px; 
            border: none; 
            border-radius: var(--radius-sm); 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 14px; 
            background: rgba(141, 198, 63, 0.15); 
            color: var(--accent-dark); 
            transition: var(--transition); 
            margin-bottom: 8px; 
        }

        .track-btn:hover { 
            background: var(--accent); 
            color: white; 
        }

        .track-btn.done { 
            background: var(--accent); 
            color: white; 
        }

        .track-btn.renew { 
            background: rgba(86, 28, 44, 0.1); 
            color: var(--primary); 
        }

        .track-btn.renew:hover { 
            background: var(--primary); 
            color: white; 
        }

        /* Reports */
        .report-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; 
            margin-bottom: 25px; 
        }

        .report-card { 
            background: var(--white); 
            border-radius: var(--radius-md); 
            padding: 25px; 
            text-align: center; 
            box-shadow: var(--shadow-lg); 
        }

        .report-value { 
            font-size: 48px; 
            font-weight: bold; 
            color: var(--primary); 
        }

        .report-label { 
            font-size: 14px; 
            color: #888; 
            margin-top: 5px; 
        }

        .progress { 
            height: 10px; 
            background: #eee; 
            border-radius: 6px; 
            margin-top: 15px; 
            overflow: hidden; 
        }

        .progress-bar { 
            height: 100%; 
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .header-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            flex-wrap: wrap; 
            gap: 15px; 
        }

        /* Confirmation Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9998;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: var(--radius-lg);
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            transform: scale(0.9);
            transition: var(--transition);
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        .modal-message {
            color: var(--gray);
            margin-bottom: 20px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .modal-actions button {
            padding: 10px 24px;
            border-radius: var(--radius-sm);
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
        }

        .modal-cancel {
            background: #e5e5e5;
            border: none;
            color: var(--text-dark);
        }

        .modal-confirm {
            background: var(--danger);
            border: none;
            color: white;
        }

        .modal-confirm:hover {
            background: #dc2626;
        }

        /* Mobile Responsive */
        @media (max-width: 600px) {
            body { padding: 10px; }
            
            .header-container h1 { font-size: 18px; }
            .logo-img { height: 60px; }
            
            .tabs { gap: 5px; }
            .tab { padding: 10px 15px; font-size: 12px; }
            
            .card { padding: 15px; }
            
            .stats { grid-template-columns: 1fr 1fr; gap: 10px; }
            .stat { padding: 15px; }
            .stat-num { font-size: 24px; }
            .stat-label { font-size: 10px; }
            
            table { font-size: 12px; }
            th, td { padding: 10px 8px; }
            
            .actions { gap: 4px; }
            .actions button { width: 32px; height: 32px; font-size: 14px; }
            
            .badge { padding: 4px 8px; font-size: 10px; }
            
            .report-grid { grid-template-columns: 1fr; }
            .report-value { font-size: 36px; }
            
            .track-grid { grid-template-columns: 1fr; }
            
            .btn { padding: 10px 15px; }
            
            .header-row { flex-direction: column; align-items: stretch; }
            
            input, select { padding: 10px; font-size: 16px; }
            
            .row { grid-template-columns: 1fr !important; }
            
            .toast { min-width: auto; width: calc(100vw - 40px); }
        }

        /* Print Styles */
        @media print {
            body { background: white; }
            .tabs, .sync, .header-row button, .actions { display: none !important; }
            .card { box-shadow: none; border: 1px solid #ddd; }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal">
            <div class="modal-icon">‚ö†Ô∏è</div>
            <div class="modal-title" id="modalTitle">Confirm Delete</div>
            <div class="modal-message" id="modalMessage">Are you sure you want to delete this patient?</div>
            <div class="modal-actions">
                <button class="modal-cancel" onclick="closeModal()">Cancel</button>
                <button class="modal-confirm" id="modalConfirm">Delete</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header-container">
            <img src="logo.png" alt="Alrazi Pharmacy" class="logo-img" onerror="this.style.display='none'"> 
            <h1>Rass 5 Refill Cash Patients System</h1>
        </div>
        
        <div class="tabs">
            <button class="tab active" data-page="patients">üìã Patients</button>
            <button class="tab" data-page="tracking">üìä Tracking</button>
            <button class="tab" data-page="reports">üìà Reports</button>
        </div>
        
        <div id="sync" class="sync sync-ok">‚úì Connected to Google Sheets</div>

        <!-- Patients Page -->
        <div id="patientsPage" class="page active">
            <div class="stats">
                <div class="stat total">
                    <div class="stat-num" id="total">0</div>
                    <div class="stat-label">Total Patients</div>
                </div>
                <div class="stat w">
                    <div class="stat-num" id="warn">0</div>
                    <div class="stat-label">Need Reminder</div>
                </div>
                <div class="stat d">
                    <div class="stat-num" id="over">0</div>
                    <div class="stat-label">Overdue</div>
                </div>
            </div>

            <div class="grid">
                <div class="card">
                    <h3 class="card-title" id="formTitle">‚ûï Add Patient</h3>
                    <form id="patientForm" novalidate>
                        <div class="form-group">
                            <label>Patient Name (Optional)</label>
                            <input type="text" id="name" placeholder="Enter patient name">
                        </div>
                        <div class="form-group">
                            <label>Phone <span style="color: var(--danger);">*</span></label>
                            <input type="tel" id="phone" placeholder="966512345678">
                            <div class="error-message" id="phoneError">Please enter a valid phone number</div>
                        </div>
                        <div class="form-group">
                            <label>Medication <span style="color: var(--danger);">*</span></label>
                            <input type="text" id="med" placeholder="Medication name">
                            <div class="error-message" id="medError">Please enter medication name</div>
                        </div>
                        <div class="row">
                            <div class="form-group">
                                <label>Dispense Date <span style="color: var(--danger);">*</span></label>
                                <input type="date" id="date">
                                <div class="error-message" id="dateError">Please select a date</div>
                            </div>
                            <div class="form-group">
                                <label>Duration (days) <span style="color: var(--danger);">*</span></label>
                                <input type="number" id="days" value="30" min="1" max="365">
                                <div class="error-message" id="daysError">Please enter a valid duration</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Notes</label>
                            <input type="text" id="notes" placeholder="Additional notes">
                        </div>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <span>‚ûï</span> Add Patient
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">Cancel</button>
                    </form>
                </div>

                <div class="card">
                    <h3 class="card-title">üìã Patient Records</h3>
                    <input type="text" id="search" placeholder="üîç Search patient, medication or phone...">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Patient</th>
                                    <th>Medication</th>
                                    <th>Refill Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="patientsTbody"></tbody>
                        </table>
                    </div>
                    <div class="pagination" id="pagination"></div>
                </div>
            </div>
        </div>

        <!-- Tracking Page -->
        <div id="trackingPage" class="page">
            <div class="stats">
                <div class="stat total">
                    <div class="stat-num" id="tSent">0</div>
                    <div class="stat-label">Reminders Sent</div>
                </div>
                <div class="stat s">
                    <div class="stat-num" id="tConverted">0</div>
                    <div class="stat-label">Converted</div>
                </div>
                <div class="stat" style="--stat-color: var(--primary);">
                    <div class="stat-num" id="tRate">0%</div>
                    <div class="stat-label">Conversion Rate</div>
                </div>
            </div>

            <div class="card">
                <div class="header-row">
                    <h3 class="card-title" style="margin: 0;">üìä Track Conversions</h3>
                    <select id="trackFilter" style="width: auto; min-width: 150px;">
                        <option value="all">All Sent</option>
                        <option value="waiting">‚è≥ Waiting</option>
                        <option value="converted">‚úÖ Converted</option>
                    </select>
                </div>
                <div class="track-grid" id="trackGrid"></div>
            </div>
        </div>

        <!-- Reports Page -->
        <div id="reportsPage" class="page">
            <div class="card">
                <div class="header-row">
                    <h3 class="card-title" style="margin: 0;">üìà Monthly Report</h3>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <select id="reportMonth" style="width: auto;"></select>
                        <select id="reportYear" style="width: auto;"></select>
                        <button class="btn btn-secondary btn-sm" onclick="window.print()">üñ®Ô∏è Print</button>
                    </div>
                </div>
            </div>
            
            <div class="report-grid">
                <div class="report-card">
                    <div class="report-value" id="rSent">0</div>
                    <div class="report-label">üì§ Reminders Sent</div>
                </div>
                <div class="report-card">
                    <div class="report-value" style="color: var(--accent);" id="rConverted">0</div>
                    <div class="report-label">‚úÖ Converted</div>
                </div>
                <div class="report-card">
                    <div class="report-value" style="color: var(--primary);" id="rRate">0%</div>
                    <div class="report-label">üìä Conversion Rate</div>
                    <div class="progress">
                        <div class="progress-bar" id="rBar" style="width:0%; background:var(--accent);"></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">üìã Summary</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Count</th>
                                <th>Percentage</th>
                            </tr>
                        </thead>
                        <tbody id="summaryTb"></tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">‚úÖ Converted Patients</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Patient</th>
                                <th>Phone</th>
                                <th>Medication</th>
                                <th>Reminder Date</th>
                                <th>Converted Date</th>
                            </tr>
                        </thead>
                        <tbody id="convList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

<script>
// ==================== Configuration ====================
const CONFIG = {
    API_URL: 'https://script.google.com/macros/s/AKfycbyLVO79BGJ77JRp_VXidIKF61LSz-J1bR1OKy6UvIdWO-1bSpoyFHtXX1WgxTXezHC6/exec',
    ITEMS_PER_PAGE: 10,
    SEARCH_DELAY: 300,
    TOAST_DURATION: 3000,
    PHONE_REGEX: /^(966|0)?5\d{8}$/,
    MONTHS: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']
};

// ==================== State Management ====================
const State = {
    patients: [],
    editId: null,
    currentPage: 1,
    searchQuery: '',
    searchTimeout: null,
    pendingDelete: null
};

// ==================== Utility Functions ====================
const Utils = {
    // Format date to YYYY-MM-DD
    formatDate(value) {
        if (!value) return '';
        if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(value)) return value;
        const date = new Date(value);
        if (isNaN(date)) return value;
        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    },

    // Get today's date in YYYY-MM-DD format
    getToday() {
        const today = new Date();
        return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
    },

    // Parse history from string or array
    parseHistory(history) {
        if (!history) return [];
        if (Array.isArray(history)) return history;
        try { return JSON.parse(history); } catch (e) { return []; }
    },

    // Calculate refill date
    getRefillDate(patient) {
        const date = new Date(patient.date);
        date.setDate(date.getDate() + parseInt(patient.days));
        return date;
    },

    // Calculate days until refill
    getDaysUntilRefill(patient) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const refill = this.getRefillDate(patient);
        refill.setHours(0, 0, 0, 0);
        return Math.ceil((refill - today) / (1000 * 60 * 60 * 24));
    },

    // Sanitize input to prevent XSS
    sanitize(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    },

    // Validate phone number
    validatePhone(phone) {
        const cleaned = phone.replace(/\D/g, '');
        return CONFIG.PHONE_REGEX.test(cleaned);
    },

    // Format phone number
    formatPhone(phone) {
        let cleaned = phone.replace(/\D/g, '');
        if (cleaned.startsWith('0')) {
            cleaned = '966' + cleaned.substring(1);
        } else if (!cleaned.startsWith('966')) {
            cleaned = '966' + cleaned;
        }
        return cleaned;
    },

    // Debounce function
    debounce(func, delay) {
        return function (...args) {
            clearTimeout(State.searchTimeout);
            State.searchTimeout = setTimeout(() => func.apply(this, args), delay);
        };
    }
};

// ==================== UI Functions ====================
const UI = {
    // Show toast notification
    showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        
        const icons = {
            success: '‚úÖ',
            error: '‚ùå',
            warning: '‚ö†Ô∏è',
            info: '‚ÑπÔ∏è'
        };
        
        toast.innerHTML = `<span>${icons[type]}</span><span>${message}</span>`;
        container.appendChild(toast);
        
        setTimeout(() => toast.remove(), CONFIG.TOAST_DURATION);
    },

    // Show/hide loading overlay
    setLoading(show) {
        document.getElementById('loadingOverlay').classList.toggle('active', show);
    },

    // Update sync status
    setSyncStatus(connected) {
        const el = document.getElementById('sync');
        el.className = connected ? 'sync sync-ok' : 'sync sync-err';
        el.textContent = connected ? '‚úì Connected to Google Sheets' : '‚ö† Offline Mode';
    },

    // Show confirmation modal
    showConfirmModal(title, message, onConfirm) {
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalMessage').textContent = message;
        document.getElementById('modalConfirm').onclick = () => {
            onConfirm();
            this.closeModal();
        };
        document.getElementById('confirmModal').classList.add('active');
    },

    // Close modal
    closeModal() {
        document.getElementById('confirmModal').classList.remove('active');
    },

    // Show field error
    showFieldError(fieldId, show) {
        const field = document.getElementById(fieldId);
        const error = document.getElementById(fieldId + 'Error');
        field.classList.toggle('error', show);
        if (error) error.classList.toggle('show', show);
    },

    // Clear all field errors
    clearFieldErrors() {
        ['phone', 'med', 'date', 'days'].forEach(field => this.showFieldError(field, false));
    }
};

// ==================== API Functions ====================
const API = {
    async request(action, data = null) {
        try {
            let url = `${CONFIG.API_URL}?action=${action}`;
            if (data) {
                url += `&data=${encodeURIComponent(JSON.stringify(data))}`;
            }
            const response = await fetch(url);
            UI.setSyncStatus(true);
            return await response.json();
        } catch (error) {
            console.error('API Error:', error);
            UI.setSyncStatus(false);
            throw error;
        }
    },

    async loadPatients() {
        UI.setLoading(true);
        try {
            const data = await this.request('get');
            State.patients = data.map(p => ({
                id: String(p.id || ''),
                name: p.name || '',
                phone: String(p.phone || ''),
                med: p.med || '',
                date: Utils.formatDate(p.date),
                days: String(p.days || '30'),
                notes: p.notes || '',
                reminderSent: p.reminderSent || 'no',
                reminderDate: Utils.formatDate(p.reminderDate),
                converted: p.converted || 'no',
                convertedDate: Utils.formatDate(p.convertedDate),
                history: Utils.parseHistory(p.history)
            }));
            localStorage.setItem('patients', JSON.stringify(State.patients));
        } catch (error) {
            State.patients = JSON.parse(localStorage.getItem('patients')) || [];
            UI.showToast('Data loaded from local storage', 'warning');
        } finally {
            UI.setLoading(false);
            renderPatients();
        }
    },

    async savePatient(patient, action) {
        const data = { ...patient, history: JSON.stringify(patient.history || []) };
        try {
            if (action === 'delete') {
                await fetch(`${CONFIG.API_URL}?action=delete&id=${patient.id}`);
            } else {
                await this.request(action, data);
            }
            UI.setSyncStatus(true);
        } catch (error) {
            UI.setSyncStatus(false);
        }
        localStorage.setItem('patients', JSON.stringify(State.patients));
    }
};

// ==================== Form Validation ====================
const Validation = {
    validateForm() {
        let isValid = true;
        UI.clearFieldErrors();

        const phone = document.getElementById('phone').value;
        const med = document.getElementById('med').value.trim();
        const date = document.getElementById('date').value;
        const days = parseInt(document.getElementById('days').value);

        if (!Utils.validatePhone(phone)) {
            UI.showFieldError('phone', true);
            isValid = false;
        }

        if (!med) {
            UI.showFieldError('med', true);
            isValid = false;
        }

        if (!date) {
            UI.showFieldError('date', true);
            isValid = false;
        }

        if (!days || days < 1 || days > 365) {
            UI.showFieldError('days', true);
            isValid = false;
        }

        return isValid;
    }
};

// ==================== Patient Actions ====================
const PatientActions = {
    async save(event) {
        event.preventDefault();
        
        if (!Validation.validateForm()) {
            UI.showToast('Please fix the errors in the form', 'error');
            return;
        }

        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerHTML = '<span>‚è≥</span> Saving...';

        const patient = {
            id: State.editId || Date.now().toString(),
            name: document.getElementById('name').value.trim(),
            phone: Utils.formatPhone(document.getElementById('phone').value),
            med: document.getElementById('med').value.trim(),
            date: document.getElementById('date').value,
            days: document.getElementById('days').value,
            notes: document.getElementById('notes').value.trim(),
            reminderSent: 'no',
            reminderDate: '',
            converted: 'no',
            convertedDate: '',
            history: []
        };

        if (State.editId) {
            const existing = State.patients.find(p => p.id === State.editId);
            patient.reminderSent = existing.reminderSent;
            patient.reminderDate = existing.reminderDate;
            patient.converted = existing.converted;
            patient.convertedDate = existing.convertedDate;
            patient.history = existing.history || [];
            
            const index = State.patients.findIndex(p => p.id === State.editId);
            State.patients[index] = patient;
        } else {
            State.patients.push(patient);
        }

        await API.savePatient(patient, State.editId ? 'update' : 'add');
        
        UI.showToast(State.editId ? 'Patient updated successfully' : 'Patient added successfully', 'success');
        
        renderPatients();
        resetForm();
        
        btn.disabled = false;
        btn.innerHTML = '<span>‚ûï</span> Add Patient';
    },

    edit(id) {
        const patient = State.patients.find(p => p.id === id);
        if (!patient) return;

        State.editId = id;
        document.getElementById('name').value = patient.name;
        document.getElementById('phone').value = patient.phone;
        document.getElementById('med').value = patient.med;
        document.getElementById('date').value = patient.date;
        document.getElementById('days').value = patient.days;
        document.getElementById('notes').value = patient.notes || '';
        
        document.getElementById('formTitle').textContent = '‚úèÔ∏è Edit Patient';
        document.getElementById('submitBtn').innerHTML = '<span>üíæ</span> Update';
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    },

    delete(id) {
        const patient = State.patients.find(p => p.id === id);
        UI.showConfirmModal(
            'Confirm Delete',
            `Are you sure you want to delete "${patient.name || 'Unnamed'}"?`,
            async () => {
                State.patients = State.patients.filter(p => p.id !== id);
                await API.savePatient({ id }, 'delete');
                UI.showToast('Patient deleted successfully', 'success');
                renderPatients();
            }
        );
    },

    sendWhatsApp(id) {
        const patient = State.patients.find(p => p.id === id);
        if (!patient) return;

        const message = `ÿßŸÑÿ≥ŸÑÿßŸÖ ÿπŸÑŸäŸÉŸÖ Ÿàÿ±ÿ≠ŸÖÿ© ÿßŸÑŸÑŸá Ÿàÿ®ÿ±ŸÉÿßÿ™Ÿá
ÿµŸäÿØŸÑŸäÿ© ÿßŸÑÿ±ÿßÿ≤Ÿä ÿßŸÑÿ±ÿ≥ 5 ÿ™ÿ±ÿ≠ÿ® ÿ®ŸÉŸÖ

Ÿáÿ∞ÿß ÿ™ÿ∞ŸÉŸäÿ± ÿ®ŸÖŸàÿπÿØ ÿµÿ±ŸÅ ÿßŸÑÿØŸàÿßÿ° ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ:

ÿßŸÑÿØŸàÿßÿ°: ${patient.med}

ŸÜÿ≥ÿπÿØ ÿ®ÿ™ÿ¨ŸáŸäÿ≤Ÿá ŸÑŸÉŸÖ ÿπÿ®ÿ±:

- ÿßŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ ŸÖŸÜ ÿßŸÑÿµŸäÿØŸÑŸäÿ©
- ÿßŸÑÿ™ŸàÿµŸäŸÑ ŸÑŸÖŸàŸÇÿπŸÉŸÖ

ŸÖŸàŸÇÿπ ÿßŸÑÿµŸäÿØŸÑŸäÿ©:
https://maps.app.goo.gl/QPvDTAaDZ8rs6YwK9

ŸÜÿ™ŸÖŸÜŸâ ŸÑŸÉŸÖ ÿØŸàÿßŸÖ ÿßŸÑÿµÿ≠ÿ© ŸàÿßŸÑÿπÿßŸÅŸäÿ©`;

        window.open(`https://wa.me/${patient.phone}?text=${encodeURIComponent(message)}`, '_blank');
        
        patient.reminderSent = 'yes';
        patient.reminderDate = Utils.getToday();
        
        API.savePatient(patient, 'update');
        UI.showToast('WhatsApp opened to send reminder', 'success');
        renderPatients();
        renderTracking();
    },

    async markConverted(id) {
        const patient = State.patients.find(p => p.id === id);
        patient.converted = 'yes';
        patient.convertedDate = Utils.getToday();
        await API.savePatient(patient, 'update');
        UI.showToast('Patient marked as converted', 'success');
        renderPatients();
        renderTracking();
    },

    async undoConverted(id) {
        const patient = State.patients.find(p => p.id === id);
        patient.converted = 'no';
        patient.convertedDate = '';
        await API.savePatient(patient, 'update');
        UI.showToast('Conversion undone', 'info');
        renderTracking();
    },

    async renewPatient(id) {
        const patient = State.patients.find(p => p.id === id);
        
        if (!patient.history) patient.history = [];
        patient.history.push({
            date: patient.date,
            reminderDate: patient.reminderDate,
            convertedDate: patient.convertedDate
        });
        
        patient.date = Utils.getToday();
        patient.reminderSent = 'no';
        patient.reminderDate = '';
        patient.converted = 'no';
        patient.convertedDate = '';
        
        await API.savePatient(patient, 'update');
        UI.showToast('Patient renewed for next month', 'success');
        renderPatients();
        renderTracking();
    }
};

// ==================== Render Functions ====================
function renderPatients() {
    const search = State.searchQuery.toLowerCase();
    let filtered = State.patients.filter(p => 
        p.name.toLowerCase().includes(search) || 
        p.med.toLowerCase().includes(search) || 
        p.phone.includes(search)
    );
    
    filtered.sort((a, b) => Utils.getRefillDate(a) - Utils.getRefillDate(b));

    // Calculate stats
    let warnings = 0, overdue = 0;
    State.patients.forEach(p => {
        const days = Utils.getDaysUntilRefill(p);
        if (days < 0) overdue++;
        else if (days <= 2) warnings++;
    });
    
    document.getElementById('total').textContent = State.patients.length;
    document.getElementById('warn').textContent = warnings;
    document.getElementById('over').textContent = overdue;

    // Pagination
    const totalPages = Math.ceil(filtered.length / CONFIG.ITEMS_PER_PAGE);
    State.currentPage = Math.min(State.currentPage, totalPages || 1);
    const startIndex = (State.currentPage - 1) * CONFIG.ITEMS_PER_PAGE;
    const paginated = filtered.slice(startIndex, startIndex + CONFIG.ITEMS_PER_PAGE);

    const tbody = document.getElementById('patientsTbody');
    
    if (paginated.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5"><div class="empty">No patients found</div></td></tr>';
        document.getElementById('pagination').innerHTML = '';
        return;
    }

    tbody.innerHTML = paginated.map(p => {
        const days = Utils.getDaysUntilRefill(p);
        const refillDate = Utils.getRefillDate(p).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        
        let status, statusClass;
        if (days < 0) {
            status = `Overdue ${Math.abs(days)}d`;
            statusClass = 'danger';
        } else if (days <= 2) {
            status = `${days}d left`;
            statusClass = 'warn';
        } else {
            status = `${days}d left`;
            statusClass = 'ok';
        }
        
        const historyCount = (p.history || []).length;
        const historyBadge = historyCount > 0 ? ` <span class="badge badge-ok">${historyCount} renewals</span>` : '';
        
        return `
            <tr>
                <td>
                    <div class="name">${Utils.sanitize(p.name) || 'Unnamed'}${historyBadge}</div>
                    <div class="phone">${Utils.sanitize(p.phone)}</div>
                </td>
                <td>
                    <div class="med">${Utils.sanitize(p.med)}</div>
                    ${p.notes ? `<div class="phone">${Utils.sanitize(p.notes)}</div>` : ''}
                </td>
                <td>${refillDate}</td>
                <td><span class="badge badge-${statusClass}">${status}</span></td>
                <td>
                    <div class="actions">
                        <button class="wa" onclick="PatientActions.sendWhatsApp('${p.id}')" title="WhatsApp">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/>
                            </svg>
                        </button>
                        <button class="edit" onclick="PatientActions.edit('${p.id}')" title="Edit">‚úèÔ∏è</button>
                        <button class="del" onclick="PatientActions.delete('${p.id}')" title="Delete">üóëÔ∏è</button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');

    // Render pagination
    renderPagination(totalPages, filtered.length);
}

function renderPagination(totalPages, totalItems) {
    const pagination = document.getElementById('pagination');
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }

    let html = `
        <button onclick="changePage(1)" ${State.currentPage === 1 ? 'disabled' : ''}>¬´</button>
        <button onclick="changePage(${State.currentPage - 1})" ${State.currentPage === 1 ? 'disabled' : ''}>‚Äπ</button>
    `;

    const maxVisiblePages = 5;
    let startPage = Math.max(1, State.currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }

    for (let i = startPage; i <= endPage; i++) {
        html += `<button onclick="changePage(${i})" class="${i === State.currentPage ? 'active' : ''}">${i}</button>`;
    }

    html += `
        <button onclick="changePage(${State.currentPage + 1})" ${State.currentPage === totalPages ? 'disabled' : ''}>‚Ä∫</button>
        <button onclick="changePage(${totalPages})" ${State.currentPage === totalPages ? 'disabled' : ''}>¬ª</button>
        <span class="pagination-info">${totalItems} patients</span>
    `;

    pagination.innerHTML = html;
}

function changePage(page) {
    State.currentPage = page;
    renderPatients();
}

function renderTracking() {
    const filter = document.getElementById('trackFilter').value;
    let list = State.patients.filter(p => p.reminderSent === 'yes');
    
    if (filter === 'waiting') {
        list = list.filter(p => p.converted !== 'yes');
    } else if (filter === 'converted') {
        list = list.filter(p => p.converted === 'yes');
    }
    
    list.sort((a, b) => new Date(b.reminderDate) - new Date(a.reminderDate));

    // Calculate totals including history
    let totalSent = 0, totalConverted = 0;
    State.patients.forEach(p => {
        if (p.reminderSent === 'yes') totalSent++;
        if (p.converted === 'yes') totalConverted++;
        (p.history || []).forEach(h => {
            if (h.reminderDate) totalSent++;
            if (h.convertedDate) totalConverted++;
        });
    });

    document.getElementById('tSent').textContent = totalSent;
    document.getElementById('tConverted').textContent = totalConverted;
    document.getElementById('tRate').textContent = totalSent > 0 ? Math.round(totalConverted / totalSent * 100) + '%' : '0%';

    const grid = document.getElementById('trackGrid');
    
    if (list.length === 0) {
        grid.innerHTML = '<div class="empty" style="grid-column:1/-1;">No records found</div>';
        return;
    }

    grid.innerHTML = list.map(p => {
        const historyCount = (p.history || []).length;
        const historyBadge = historyCount > 0 ? `<div class="history-badge">üîÑ ${historyCount} previous cycles</div>` : '';
        
        if (p.converted === 'yes') {
            return `
                <div class="track-card converted">
                    ${historyBadge}
                    <div class="name">${Utils.sanitize(p.name) || 'Unnamed'}</div>
                    <div class="phone">${Utils.sanitize(p.phone)}</div>
                    <div class="med">${Utils.sanitize(p.med)}</div>
                    <div class="info">
                        üì§ Sent: ${p.reminderDate}<br>
                        ‚úÖ Converted: ${p.convertedDate}
                    </div>
                    <button class="track-btn done" onclick="PatientActions.undoConverted('${p.id}')">‚úÖ Converted (Click to Undo)</button>
                    <button class="track-btn renew" onclick="PatientActions.renewPatient('${p.id}')">üîÑ Renew for Next Month</button>
                </div>
            `;
        } else {
            return `
                <div class="track-card">
                    ${historyBadge}
                    <div class="name">${Utils.sanitize(p.name) || 'Unnamed'}</div>
                    <div class="phone">${Utils.sanitize(p.phone)}</div>
                    <div class="med">${Utils.sanitize(p.med)}</div>
                    <div class="info">üì§ Sent: ${p.reminderDate}</div>
                    <button class="track-btn" onclick="PatientActions.markConverted('${p.id}')">‚úÖ Mark as Converted</button>
                </div>
            `;
        }
    }).join('');
}

function generateReport() {
    const month = parseInt(document.getElementById('reportMonth').value);
    const year = parseInt(document.getElementById('reportYear').value);

    let sent = 0, converted = 0;
    const convertedPatients = [];

    State.patients.forEach(p => {
        // Check current cycle
        if (p.reminderSent === 'yes' && p.reminderDate) {
            const rd = new Date(p.reminderDate);
            if (rd.getMonth() === month && rd.getFullYear() === year) {
                sent++;
                if (p.converted === 'yes') {
                    converted++;
                    convertedPatients.push({
                        name: p.name,
                        phone: p.phone,
                        med: p.med,
                        reminderDate: p.reminderDate,
                        convertedDate: p.convertedDate
                    });
                }
            }
        }
        
        // Check history
        (p.history || []).forEach(h => {
            if (h.reminderDate) {
                const rd = new Date(h.reminderDate);
                if (rd.getMonth() === month && rd.getFullYear() === year) {
                    sent++;
                    if (h.convertedDate) {
                        converted++;
                        convertedPatients.push({
                            name: p.name,
                            phone: p.phone,
                            med: p.med,
                            reminderDate: h.reminderDate,
                            convertedDate: h.convertedDate
                        });
                    }
                }
            }
        });
    });

    const rate = sent > 0 ? Math.round(converted / sent * 100) : 0;
    const waiting = sent - converted;
    const waitingRate = sent > 0 ? Math.round(waiting / sent * 100) : 0;

    document.getElementById('rSent').textContent = sent;
    document.getElementById('rConverted').textContent = converted;
    document.getElementById('rRate').textContent = rate + '%';
    document.getElementById('rBar').style.width = rate + '%';

    document.getElementById('summaryTb').innerHTML = `
        <tr><td>üì§ Reminders Sent</td><td>${sent}</td><td>100%</td></tr>
        <tr><td>‚úÖ Converted</td><td>${converted}</td><td>${rate}%</td></tr>
        <tr><td>‚è≥ Waiting</td><td>${waiting}</td><td>${waitingRate}%</td></tr>
    `;

    document.getElementById('convList').innerHTML = convertedPatients.length > 0
        ? convertedPatients.map(p => `
            <tr>
                <td class="name">${Utils.sanitize(p.name) || 'Unnamed'}</td>
                <td class="phone">${Utils.sanitize(p.phone)}</td>
                <td class="med">${Utils.sanitize(p.med)}</td>
                <td>${p.reminderDate}</td>
                <td>${p.convertedDate}</td>
            </tr>
        `).join('')
        : '<tr><td colspan="5"><div class="empty">No conversions this month</div></td></tr>';
}

function resetForm() {
    State.editId = null;
    document.getElementById('patientForm').reset();
    document.getElementById('days').value = '30';
    document.getElementById('date').valueAsDate = new Date();
    document.getElementById('formTitle').textContent = '‚ûï Add Patient';
    document.getElementById('submitBtn').innerHTML = '<span>‚ûï</span> Add Patient';
    UI.clearFieldErrors();
}

function showPage(pageName) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById(pageName + 'Page').classList.add('active');
    document.querySelector(`[data-page="${pageName}"]`).classList.add('active');
    
    if (pageName === 'tracking') renderTracking();
    if (pageName === 'reports') generateReport();
}

// Make functions globally accessible
window.PatientActions = PatientActions;
window.changePage = changePage;
window.resetForm = resetForm;
window.closeModal = UI.closeModal;

// ==================== Initialization ====================
document.addEventListener('DOMContentLoaded', () => {
    // Initialize date picker
    document.getElementById('date').valueAsDate = new Date();
    
    // Initialize month/year selectors
    const monthSelect = document.getElementById('reportMonth');
    const yearSelect = document.getElementById('reportYear');
    const currentDate = new Date();
    
    CONFIG.MONTHS.forEach((month, index) => {
        monthSelect.innerHTML += `<option value="${index}">${month}</option>`;
    });
    monthSelect.value = currentDate.getMonth();
    
    for (let year = currentDate.getFullYear(); year <= currentDate.getFullYear() + 3; year++) {
        yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
    }
    yearSelect.value = currentDate.getFullYear();
    
    // Tab click handlers
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => showPage(tab.dataset.page));
    });
    
    // Form submit handler
    document.getElementById('patientForm').addEventListener('submit', PatientActions.save);
    
    // Search with debounce
    document.getElementById('search').addEventListener('input', Utils.debounce((e) => {
        State.searchQuery = e.target.value;
        State.currentPage = 1;
        renderPatients();
    }, CONFIG.SEARCH_DELAY));
    
    // Track filter change
    document.getElementById('trackFilter').addEventListener('change', renderTracking);
    
    // Report selectors change
    document.getElementById('reportMonth').addEventListener('change', generateReport);
    document.getElementById('reportYear').addEventListener('change', generateReport);
    
    // Load data
    API.loadPatients();
});
</script>
</body>
</html>
